<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Masomo SMS Products</title>
<style>
  /* General body & container */
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#f5f7fa,#c3cfe2); margin:0; padding:0; }
  .container { max-width: 900px; margin:50px auto; padding:25px; background:#fff; border-radius:12px; box-shadow:0 8px 25px rgba(0,0,0,0.15); transition: transform 0.3s ease; }
  .container:hover { transform: translateY(-5px); }

  /* Headings & intro */
  h1 { text-align:center; margin-bottom:15px; color:#2c3e50; letter-spacing:1px; }
  p.intro { font-weight:bold; color:#007bff; text-align:center; font-size:16px; margin-bottom:30px; }

  /* Login form */
  .login-form { display:flex; flex-direction:column; gap:15px; margin-bottom:30px; }
  .login-form input { padding:12px; font-size:16px; border-radius:8px; border:1px solid #ccc; transition: border-color 0.3s, box-shadow 0.3s; }
  .login-form input:focus { border-color:#007bff; box-shadow:0 0 8px rgba(0,123,255,0.3); outline:none; }

  /* Buttons */
  .login-form button { padding:12px; font-size:16px; background:#28a745; color:#fff; border:none; border-radius:8px; cursor:pointer; transition: background 0.3s, transform 0.2s; }
  .login-form button:hover { background:#218838; transform: scale(1.05); }

  .prime-button { display:inline-block; background-color:red; color:white; padding:12px 25px; text-decoration:none; border-radius:8px; margin-top:5px; text-align:center; line-height:1.5; font-weight:bold; transition: transform 0.2s, box-shadow 0.3s; }
  .prime-button:hover { transform: scale(1.05); box-shadow:0 4px 15px rgba(0,0,0,0.2); }

  /* Messages */
  .error { color:red; font-weight:bold; margin-bottom:15px; text-align:center; }
  .status { color:green; font-weight:bold; text-align:center; margin-top:10px; }

  /* Products grid */
  .products { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:20px; }
  .product-card { border:1px solid #ddd; border-radius:12px; overflow:hidden; background:#fff; display:flex; flex-direction:column; transition: transform 0.3s, box-shadow 0.3s; }
  .product-card:hover { transform: translateY(-5px); box-shadow:0 8px 20px rgba(0,0,0,0.1); }

  .product-card img { width:100%; height:160px; object-fit:cover; transition: transform 0.3s; }
  .product-card:hover img { transform: scale(1.05); }

  .product-content { padding:15px; flex:1; display:flex; flex-direction:column; justify-content:space-between; }
  .product-title { font-size:18px; font-weight:bold; margin-bottom:10px; color:#2c3e50; }
  .product-desc { flex:1; font-size:14px; margin-bottom:10px; color:#555; }
  .product-link { text-align:center; padding:10px; background:#007bff; color:#fff; text-decoration:none; border-radius:5px; font-weight:bold; transition: background 0.3s, transform 0.2s; cursor:pointer; }
  .product-link:hover { background:#0056b3; transform: scale(1.05); }

  /* Smooth fade-in for products */
  #products-section { opacity:0; transition: opacity 0.8s ease-in; }
  #products-section.show { opacity:1; }

  /* Viewer */
  #viewer { margin-top:30px; }
  #product-frame { width:100%; height:600px; border:1px solid #ccc; border-radius:8px; display:none; }
</style>
</head>
<body>

<div class="container">
  <img src="https://i.imgur.com/77srEUJ.png" alt="Masomo SMS Logo" style="display:block; margin:0 auto 20px auto; max-width:120px; height:auto;">
  <h1>User Products</h1>
  <p class="intro">
    Login to view PDFs, EBooks, Short Videos, Photos etc from your Users.
  </p>

  <div class="login-section">
    <div id="error-message" class="error"></div>
    <form id="login-form" class="login-form">
      <input type="text" id="nationalId" placeholder="Enter User National ID" required>
      <input type="text" id="phoneNumber" placeholder="Enter Your Phone Number" required>
      <button type="submit">Login</button>
      <br>
      <a href="https://masomodigital.github.io/PRIME-CONTACTS/" class="prime-button">
        Sign Up As A Prime Contact
      </a>
    </form>
    <div id="login-status" class="status"></div> <!-- Status message -->
  </div>

  <div id="products-section" class="products"></div>

  <!-- Viewer Section -->
  <div id="viewer">
    <iframe id="product-frame"></iframe>
  </div>
</div>

<script>
const WEB_APP_URL = "https://twilight-smoke-5655.ev-dmaundu.workers.dev/";

function normalizePhone(phone) {
  return phone.toString().replace(/\D/g, "").slice(-9);
}

document.getElementById("login-form").addEventListener("submit", async function(e) {
  e.preventDefault();
  document.getElementById("error-message").textContent = "";
  document.getElementById("login-status").textContent = "Wait please..."; // Show green message

  const nationalId = document.getElementById("nationalId").value.trim();
  const phoneNumber = normalizePhone(document.getElementById("phoneNumber").value.trim());

  if (!nationalId || !phoneNumber) {
    document.getElementById("error-message").textContent = "Please enter both fields.";
    document.getElementById("login-status").textContent = ""; // Clear green message
    return;
  }

  try {
    const response = await fetch(WEB_APP_URL, {
      method: "POST",
      body: JSON.stringify({ nationalId, phoneNumber }),
      headers: { "Content-Type": "application/json" }
    });

    const data = await response.json();
    console.log("Backend response:", data);

    if (!data.success) {
      document.getElementById("error-message").textContent = data.message || "Access denied.";
      document.getElementById("login-status").textContent = ""; // Clear green message
      return;
    }

    // Show products
    const productsSection = document.getElementById("products-section");
    productsSection.innerHTML = "";
    productsSection.style.display = "grid";

    data.products.forEach(product => {
      const card = document.createElement("div");
      card.className = "product-card";

      const img = document.createElement("img");
      img.src = product.coverImage || "https://via.placeholder.com/300x160?text=No+Image";
      card.appendChild(img);

      const content = document.createElement("div");
      content.className = "product-content";

      const title = document.createElement("div");
      title.className = "product-title";
      title.textContent = product.title;
      content.appendChild(title);

      const desc = document.createElement("div");
      desc.className = "product-desc";
      desc.textContent = product.description || "";
      content.appendChild(desc);

      const link = document.createElement("button");
      link.className = "product-link";
      link.textContent = "View / Download";
      link.onclick = () => {
        const frame = document.getElementById("product-frame");
        let fileUrl = product.fileLink;

        // If it's a Google Drive link, convert to preview
        const driveMatch = fileUrl.match(/https:\/\/drive\.google\.com\/file\/d\/([^/]+)/);
        if (driveMatch) {
          const fileId = driveMatch[1];
          fileUrl = `https://drive.google.com/file/d/${fileId}/preview`;
        }

        frame.src = fileUrl;
        frame.style.display = "block";
        frame.scrollIntoView({ behavior: "smooth" });
      };
      content.appendChild(link);

      // Add Views count
      const views = document.createElement("div");
      views.style.marginTop = "8px";
      views.style.textAlign = "center";
      views.style.color = "#444";
      views.textContent = `Views/Downloads: ${product.views || 0}`;
      content.appendChild(views);

      card.appendChild(content);
      productsSection.appendChild(card);
    });

    document.getElementById("login-form").style.display = "none";
    productsSection.classList.add("show"); // fade-in animation
    document.getElementById("login-status").textContent = ""; // Clear green message

  } catch (err) {
    console.error(err);
    document.getElementById("error-message").textContent = "Server error. Please try again.";
    document.getElementById("login-status").textContent = ""; // Clear green message
  }
});
</script>

</body>
</html>
